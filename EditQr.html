<!DOCTYPE html>
<html lang="en">
<head>
  <title>Edit QR Code Data</title>
  <!-- Add your meta tags and CSS links here -->
</head>
<body>
  <!-- <link rel="stylesheet" href="./style.css" /> -->
  <div>
    <!-- <link href="./edit-qr.css" rel="stylesheet" /> -->
    <div class="edit-qr-container">
      <section class="edit-qr-hero">
        <!-- Header content can be copied from the previous HTML file -->
      </section>
      <footer class="edit-qr-footer">
        <!-- Footer content can be copied from the previous HTML file -->
      </footer>
    </div>
  </div>

  <!-- Edit QR Code Form -->
  <div class="edit-qr-form">
    <h2>Edit QR Code Data</h2>
    <form id="editQRForm" onsubmit="editQRData(event)">
      <label for="qrId">QR ID:</label>
      <input type="text" id="qrId" name="qrId" readonly />

      <label for="fullName">Full Name:</label>
      <input type="text" id="fullName" name="Name"/>

      <label for="age">Age:</label>
      <input type="number" id="age" name="age"/>

      <label for="bloodGroup">Blood Group:</label>
      <input type="text" id="bloodGroup" name="BloodGroup"/>

      <label for="preMedicalInfo">Pre-Medical Conditions:</label>
      <textarea id="preMedicalInfo" name="preMedicalInfo" rows="3"></textarea>

      <label for="vehicleNumber">Vehicle Number:</label>
      <input type="text" id="vehicleNumber" name="vehicleNumber"/>

      <h3>Emergency Contacts:</h3>

      <label for="emergencyContact1Name">Contact 1 Name:</label>
      <input type="text" id="emergencyContact1Name" name="emergencyContact1Name"/>

      <label for="emergencyContact1Relation">Contact 1 Relation:</label>
      <input type="text" id="emergencyContact1Relation" name="emergencyContact1Relation"/>

      <label for="emergencyContact1Number">Contact 1 Number:</label>
      <input type="tel" id="emergencyContact1Number" name="emergencyContact1Number"/>

      <label for="emergencyContact2Name">Contact 2 Name:</label>
      <input type="text" id="emergencyContact2Name" name="emergencyContact2Name"/>

      <label for="emergencyContact2Relation">Contact 2 Relation:</label>
      <input type="text" id="emergencyContact2Relation" name="emergencyContact2Relation"/>

      <label for="emergencyContact2Number">Contact 2 Number:</label>
      <input type="tel" id="emergencyContact2Number" name="emergencyContact2Number"/>

      <button type="submit">Save Changes</button>
    </form>
  </div>

  <script>
    // JavaScript for editing QR code data goes here
    // Get the QR ID from the query parameter in the URL
    const urlParams = new URLSearchParams(window.location.search);
    const qrId = urlParams.get('qrId');
  
    // Check if the qrCode is not empty or null
if (qrId) {
  // Now you have the qrCode value, and you can proceed to use it in your fetch request or elsewhere.
  console.log(`QR Code: ${qrId}`);
} else {
  console.log('QR Code is missing or empty');
}
    // Populate the QR ID field
    document.getElementById('qrId').value = qrId;

    // Function to fetch user data based on qrId and populate the form
    function fetchAndPopulateUserData() {
      const url = `http://localhost:4000/api/v1/users/qr/${qrId}`;

      fetch(url)
        .then((response) => response.json())
        .then((data) => {
     // Check if data.EmergencyContact exists before accessing its properties
     if (data.EmergencyContact) {
                const contact1 = data.EmergencyContact.Contact1 || {};
                const contact2 = data.EmergencyContact.Contact2 || {};

                // Populate the form with user data
                document.getElementById("qrId").value = data.QrId || "";
                document.getElementById("Name").value = data.Name || "";
                document.getElementById("emergencyContact1Name").value = contact1.Name || "";
                document.getElementById("emergencyContact1Relation").value = contact1.relation || "";
                document.getElementById("emergencyContact1Number").value = contact1.phoneNumber || "";
                document.getElementById("emergencyContact2Name").value = contact2.Name || "";
                document.getElementById("emergencyContact2Relation").value = contact2.relation || "";
                document.getElementById("emergencyContact2Number").value = contact2.phoneNumber || "";
            }   })
        .catch((error) => {
          console.error('Error fetching user data:', error);
          alert('Error fetching user data. Please try again.');
        });
    }

    // Call the function to populate user data
    fetchAndPopulateUserData();

    // Function to edit QR data
    function editQRData(event) {
      event.preventDefault();

      // Get the edited data from the form fields
      const fullName = document.getElementById('fullName').value;
      const age = parseInt(document.getElementById('age').value);
      const bloodGroup = document.getElementById('bloodGroup').value;
      const preMedicalInfo = document.getElementById('preMedicalInfo').value;
      const vehicleNumber = document.getElementById('vehicleNumber').value;
      const emergencyContact1Name = document.getElementById('emergencyContact1Name').value;
      const emergencyContact1Relation = document.getElementById('emergencyContact1Relation').value;
      const emergencyContact1Number = document.getElementById('emergencyContact1Number').value;
      const emergencyContact2Name = document.getElementById('emergencyContact2Name').value;
      const emergencyContact2Relation = document.getElementById('emergencyContact2Relation').value;
      const emergencyContact2Number = document.getElementById('emergencyContact2Number').value;

      // Create a JavaScript object with the edited data
      const data = {
        Name: fullName,
        age: age,
        BloodGroup: bloodGroup,
        preMedicalInfo: preMedicalInfo,
        vehicleNumber: vehicleNumber,
        EmergencyContact: {
          Contact1: {
            Name: emergencyContact1Name,
            relation: emergencyContact1Relation,
            phoneNumber: emergencyContact1Number,
          },
          Contact2: {
            Name: emergencyContact2Name,
            relation: emergencyContact2Relation,
            phoneNumber: emergencyContact2Number,
          },
        },
      };

      // Convert the data object to a JSON string
      const jsonData = JSON.stringify(data);
      const url = `http://localhost:4000/api/v1/users/edit-qr/${qrId}`;

      // Use the fetch API to send the edited data to the server
      fetch(url, {
        method: 'PATCH',
        body: jsonData,
        headers: {
          'Content-Type': 'application/json',
        },
      })
        .then((response) => {
          if (response.ok) {
            alert('Data edited successfully!');
          } else {
            alert('Error editing data. Please try again.');
          }
        })
        .catch((error) => {
          alert('An error occurred. Please try again later.');
        });
    }
  </script>
</body>
</html>
